<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- 52_storage.qdoc -->
  <title>mobile_html5 : Data Storage</title>
  <link rel="stylesheet" type="text/css" href="style/styles.css" />
</head>
<body>
<?php $title = 'Documentation'; include('../../header.inc'); ?>
<style>
.level1 { margin-left: 0em }
.level2 { margin-left: 2em }
.level3 { margin-left: 4em }
.level4 { margin-left: 6em }
.level5 { margin-left: 8em }
pre, blockquote { padding: 1.0em; border: thin solid #777; border-radius: 1.0em; margin: 1.0em; }
pre{white-space:pre;overflow-x:scroll;background-image:-webkit-linear-gradient(0deg,#ddd,#aaa);}
blockquote { background: #ddd; width: 500px; float: right;  }
blockquote > h3 { text-align: center; margin: 0 }
footer { font-size: x-small; text-align: center }
img[src*='support_'] { float: right; margin-left: 0.25em; height: 36px; width: 36px; border-radius: 0.5em }
</style>
<a href=index.html>[Index]</a>
<!-- START --><div class="toc">
<h3><a name="toc">Contents</a></h3>
<ul>
<li class="level1"><a href="#web-storage">Web Storage</a></li>
<li class="level1"><a href="#web-sql">Web SQL</a></li>
<li class="level1"><a href="#zzz-simple-web-storage">ZZZ Simple Web Storage</a></li>
<li class="level1"><a href="#xxx">XXX ???</a></li>
<li class="level3"><a href="#ooo-web-sql">ooo Web SQL</a></li>
<li class="level3"><a href="#ooo-web-sql-databases">ooo Web SQL Databases</a></li>
<li class="level3"><a href="#ooo-creating-and-opening-a-new-database">ooo Creating and Opening a New Database</a></li>
<li class="level3"><a href="#ooo-errors">ooo Errors</a></li>
<li class="level3"><a href="#ooo-transaction-calls-and-executesql-method">ooo Transaction Calls and ExecuteSQL Method</a></li>
<li class="level3"><a href="#ooo-changing-database-versions">ooo Changing Database Versions</a></li>
<li class="level1"><a href="#xxx">XXX ???</a></li>
<li class="level3"><a href="#ooo-web-storage">ooo Web Storage</a></li>
<li class="level3"><a href="#ooo-simple-data-storage">ooo Simple Data Storage</a></li>
<li class="level3"><a href="#ooo-storage-events">ooo Storage Events</a></li>
<li class="level3"><a href="#ooo-storage-intro">ooo Storage Intro</a></li>
<li class="level3"><a href="#ooo-storing-non-string-data">ooo Storing Non-String Data</a></li>
<li class="level1"><a href="#xxx">XXX ???</a></li>
<li class="level3"><a href="#ooo-web-sql">ooo Web SQL</a></li>
<li class="level3"><a href="#ooo-web-sql-databases">ooo Web SQL Databases</a></li>
<li class="level3"><a href="#ooo-creating-and-opening-a-new-database">ooo Creating and Opening a New Database</a></li>
<li class="level3"><a href="#ooo-errors">ooo Errors</a></li>
<li class="level3"><a href="#ooo-transaction-calls-and-executesql-method">ooo Transaction Calls and ExecuteSQL Method</a></li>
<li class="level3"><a href="#ooo-changing-database-versions">ooo Changing Database Versions</a></li>
<li class="level1"><a href="#xxx">XXX ???</a></li>
<li class="level3"><a href="#ooo-web-storage">ooo Web Storage</a></li>
<li class="level3"><a href="#ooo-simple-data-storage">ooo Simple Data Storage</a></li>
<li class="level3"><a href="#ooo-storage-events">ooo Storage Events</a></li>
<li class="level3"><a href="#ooo-storage-intro">ooo Storage Intro</a></li>
<li class="level3"><a href="#ooo-storing-non-string-data">ooo Storing Non-String Data</a></li>
</ul>
</div>
<h1 class="title">Data Storage</h1>
<span class="subtitle"></span>
<!-- $$$storage.html-description -->
<div class="descr"> <a name="details"></a>
<p>Client-side storage is necessary to enable HTML-based applications that <a href="offline.html">operate offline</a>, and is desirable to reduce the amount of sensitive data transmitted in network requests. The Browser supports simple key/value-based HTML5 <i>web storage</i> &mdash; <tt>localStorage</tt> and <tt>sessionStorage</tt>. For more complex storage options, see <a href="#web-sql">Web SQL</a>.</p>
<a name="web-storage"></a>
<h2>Web Storage</h2>
<a name="web-sql"></a>
<h2>Web SQL</h2>
<a name="zzz-simple-web-storage"></a>
<h2>ZZZ Simple Web Storage</h2>
<p>Web storage has two flavors: <tt>localStorage</tt> and <tt>sessionStorage</tt>. Session data is available for each site and for the duration of each browser window. Local data is available for each site indefinitely, following termination of the browser application or web app. Other than the scope of their data and access via <tt>window.localStorage</tt> and <tt>window.sessionStorage</tt> objects, the interface for each API is identical.</p>
<p>The following illustrates the full set of method calls:</p>
<pre class="cpp"><span class="comment">// is client storage available?</span>
<span class="keyword">if</span> (window<span class="operator">.</span>localStorage) {
    var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
    <span class="comment">// get key (If null, doesn't exist):</span>
    var value <span class="operator">=</span> JSON<span class="operator">.</span>parse( db<span class="operator">.</span>getItem(<span class="string">&quot;key&quot;</span>) );
    <span class="keyword">try</span> {
        <span class="comment">// set key:</span>
        db<span class="operator">.</span>setItem(<span class="string">&quot;key&quot;</span><span class="operator">,</span> JSON<span class="operator">.</span>stringify(<span class="string">&quot;new value&quot;</span>) );
    } <span class="keyword">catch</span>(err) {
        <span class="keyword">if</span> (err<span class="operator">.</span>QUOTA_EXCEEDED_ERR) {
            <span class="comment">// not enough storage space</span>
        }
    }
    db<span class="operator">.</span>removeItem(<span class="string">&quot;key&quot;</span>); <span class="comment">// delete key</span>
    db<span class="operator">.</span>clear();           <span class="comment">// delete all keys</span>
}
<span class="keyword">else</span> {
    <span class="comment">// store data remotely?</span>
}</pre>
<p>Overall storage space is limited to 5MB, which this example accounts for by checking <tt>QUOTA_EXCEEDED_ERR</tt>. All data is stored in string format, so converting to and from JSON allows you to avoid other errors in which data's original <i>type</i> is lost.</p>
<p>The <tt>length</tt> and <tt>key</tt> methods allow you to iterate over all keys using array indexes. This example mirrors a set of stored items as a JavaScript object:</p>
<pre class="cpp">var obj <span class="operator">=</span> {};
<span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span><span class="operator">,</span> l <span class="operator">=</span> db<span class="operator">.</span>length ; i <span class="operator">&lt;</span> l ; i<span class="operator">+</span><span class="operator">+</span>) {
    obj<span class="operator">[</span>db<span class="operator">.</span>key(i)<span class="operator">]</span> <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(db<span class="operator">.</span>key(i)));
}</pre>
<p>Applications can respond to all database changes using <tt>storage</tt> events, which fire on the <tt>window</tt> object. The <tt>event.oldValue</tt> and <tt>event.newValue</tt> properties provide both strings. The <tt>event.key</tt> property returns the name of the key being modified, and <tt>event.storageArea</tt> returns whichever of the <tt>window.localStorage</tt> or <tt>window.sessionStorage</tt> databases are affected. This simple example presents a visual feedback that data is being stored on the device:</p>
<pre class="cpp">window<span class="operator">.</span>addEventListener(<span class="string">&quot;storage&quot;</span><span class="operator">,</span> function(e){
    var i <span class="operator">=</span> document<span class="operator">.</span>querySelector(<span class="string">&quot;#storage_indicator&quot;</span>);
    (e<span class="operator">.</span>storageArea<span class="operator">.</span>length)
        <span class="operator">?</span> (i<span class="operator">.</span>classlist<span class="operator">.</span>add(<span class="string">&quot;write&quot;</span>))
        : (i<span class="operator">.</span>classlist<span class="operator">.</span>remove(<span class="string">&quot;write&quot;</span>));
}<span class="operator">,</span> <span class="keyword">false</span>);</pre>
<p>In this example, users make corrections to text. If they close the application before completing their work, correct answers are reflected on the page when they re-open it:</p>
<p><a href="../examples/editable.htm"> <img src="images/editable.png" alt="" /> </a></p>
<p><a href="../examples/editable.htm"> __IFRAME__ </a> <a href="../examples/editable.htm"> <img src="images/icon_html.png" alt="" /> </a> <a href="../examples/css/editable.css"> <img src="images/icon_css.png" alt="" /> </a> <a href="../examples/js/editable.js"> <img src="images/icon_js.png" alt="" /> </a></p>
<a name="xxx"></a>
<h2>XXX ???</h2>
<a name="ooo-web-sql"></a>
<h4>ooo Web SQL</h4>
<p>Use the Web SQL feature for more advanced SQL-driven database applications that execute entirely on the client browser, but that fall beyond the capabilities of the simple key/value-based Web Storage system described above.</p>
<p>Use <tt>openDatabase</tt> to create or access a database, supplying parameters for unique database name, version number, display name, and estimated size:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'dbname'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my database'</span><span class="operator">,</span> <span class="number">1024</span>);</pre>
<p>You interact with the database using asynchronous SQL transactions. The following shows how you might create a table, insert data by mapping in JavaScript variables, and traverse existing data:</p>
<pre class="cpp">var x_id<span class="operator">,</span> x_value;
db<span class="operator">.</span>transaction(function (tx) {
    tx<span class="operator">.</span>executeSql(<span class="char">'CREATE TABLE IF NOT EXISTS tbl (id unique, text)'</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO tbl (id, text) VALUES (?, ?)'</span><span class="operator">,</span> <span class="operator">[</span>x_id<span class="operator">,</span> x_value<span class="operator">]</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'SELECT * FROM tbl'</span><span class="operator">,</span> <span class="operator">[</span><span class="operator">]</span><span class="operator">,</span> function(tx<span class="operator">,</span> results) {
        <span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span> <span class="operator">,</span> l <span class="operator">=</span> results<span class="operator">.</span>rows<span class="operator">.</span>length; i <span class="operator">&lt;</span> l; i<span class="operator">+</span><span class="operator">+</span>) {
            <span class="comment">// do something with results.rows.item(i).text</span>
        }
    });
});</pre>
<a name="ooo-web-sql-databases"></a>
<h4>ooo Web SQL Databases</h4>
<p>While common local- or session-based databases are capable of storing complex data structures, WebKit-based browsers can also rely upon the Web SQL standard, which brings SQLite-based structured database functionality, typically deployed on servers, to client browser applications. Based on SQLite version 3.6&#x2e;19, Web SQL is appropriate for data-intensive applications requiring complex queries rather than simple key/value access.</p>
<p>The following test confirms support for Web SQL:</p>
<pre class="cpp"><span class="keyword">if</span> (<span class="operator">!</span><span class="operator">!</span>window<span class="operator">.</span>openDatabase) {
    <span class="comment">// supports Web SQL</span>
}</pre>
<p>Calls to databases made via the Web SQL API are made asynchronously via transactions to avoid the user interface from locking up, as database interaction may occur from several windows at a time.</p>
<p>The three core API methods are:</p>
<ul>
<li><tt>openDatabase()</tt></li>
<li><tt>transaction()</tt></li>
<li><tt>executeSql()</tt></li>
</ul>
<a name="ooo-creating-and-opening-a-new-database"></a>
<h4>ooo Creating and Opening a New Database</h4>
<p>To create and open a database, use <tt>openDatabase()</tt>on the Window object, for example:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'mydb'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my first database'</span><span class="operator">,</span> <span class="number">2</span><span class="operator">*</span><span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>);
var db <span class="operator">=</span> openDatabase(<span class="char">'notes'</span><span class="operator">,</span> <span class="char">''</span><span class="operator">,</span> <span class="char">'The Example Notes App!'</span><span class="operator">,</span> <span class="number">1048576</span>);</pre>
<p>The four required arguments are the database name, version, display name, and estimated size in bytes. You can supply a function as an optional fifth argument to serve as a callback when a database is created. It may be used to call the <tt>changeversion()</tt> method, in which case the callback is invoked with an empty string for the database version.</p>
<p>The second example above specifies an empty string for the version. In this case the database opens no matter what the database version is. (An <tt>openDatabase()</tt> call specifying the wrong version for an existing database throws an <tt>INVALID_STATE_ERR</tt> exception.) You can then query the version by examining the database object's version property, for example:</p>
<pre class="cpp">var version <span class="operator">=</span> db<span class="operator">.</span>version;</pre>
<p>Note that you don't need to close a client-side Web SQL database when you're done working with it.</p>
<a name="ooo-errors"></a>
<h4>ooo Errors</h4>
<p>Asynchronous API errors are reported using callbacks that have a <tt>SQLError</tt> object as one of their arguments. <tt>SQLError</tt> contains a code from the table below and a localized message string.</p>
<p>Error codes are:</p>
<ul>
<li>0 <tt>UNKNOWN_ERROR</tt> Transaction failed for reasons unrelated to the DB</li>
<li>1 <tt>DATABASE_ERROR</tt> Statement failed for DB reasons not covered by other code</li>
<li>2 <tt>VERSION_ERROR</tt> DB version doesn't match expected version</li>
<li>3 <tt>TOO_LARGE_ERROR</tt> Data returned from DB was too large. Try the <tt>SQL LIMIT</tt> modifier.</li>
<li>4 <tt>QUOTA_ERROR</tt> Insufficient remaining storage</li>
<li>5 <tt>SYNTAX_ERROR</tt> Syntax error, argument mismatch, or unallowed statement</li>
<li>6 <tt>CONSTRAINT_ERROR</tt> An <tt>INSERT</tt>, <tt>UPDATE</tt>, or <tt>REPLACE</tt> statement failed due to a constraint error</li>
<li>7 <tt>TIMEOUT_ERROR</tt> Timeout waiting for transaction lock</li>
</ul>
<p><b>See Also:</b> <a href="http://html5doctor.com/introducing-web-sql-databases/">HTML5 Doctor: Introducing Web SQL Databases</a></p>
<a name="ooo-transaction-calls-and-executesql-method"></a>
<h4>ooo Transaction Calls and ExecuteSQL Method</h4>
<p>Performing database transactions is superior to running SQL statements directly because transactions are not committed if they fail and you can undo them if needed. Transactions also allow you to handle errors using a callback. To implement a transaction, specify a callback function such as the following:</p>
<pre class="cpp">db<span class="operator">.</span>transaction(function (tx) {
  <span class="comment">// SQL details on the tx object go here</span>
}</pre>
<p>The <tt>transaction()</tt> method takes one to three arguments:</p>
<ul>
<li>a required transaction callback, in which <tt>executeSQL()</tt> calls belong</li>
<li>an optional transaction error object</li>
<li>an optional success callback.</li>
</ul>
<p>Use the <tt>executeSQL()</tt> method to specify SQL statements for read and write operations. The method protects against SQL injection and provides a callback method to process the results of any SQL queries you specify. The <tt>executeSQL()</tt> method takes from one to four arguments:</p>
<ul>
<li>a required SQL statement</li>
<li>an optional object array of arguments</li>
<li>an optional SQL statement callback</li>
<li>an optional SQL statement error callback</li>
</ul>
<p>The example below creates the database if it doesn't exist, adds a two-column table to the database, and adds a row of data to the table:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'mydb'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my first database'</span><span class="operator">,</span> <span class="number">2</span> <span class="operator">*</span> <span class="number">1024</span> <span class="operator">*</span> <span class="number">1024</span>);
db<span class="operator">.</span>transaction(function (tx) {
    tx<span class="operator">.</span>executeSql(<span class="char">'CREATE TABLE IF NOT EXISTS foo (id unique, text)'</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO foo (id, text) VALUES (1, &quot;synergies&quot;)'</span>);
});</pre>
<p>To capture data from the user or an external source, use <tt>?</tt> placeholders to map that data into the SQL query. This ensures the data doesn't compromise database security, for example from SQL injection:</p>
<pre class="cpp">tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO foo (id, text) VALUES (?, ?)'</span><span class="operator">,</span> <span class="operator">[</span>id<span class="operator">,</span> value<span class="operator">]</span>);</pre>
<p><tt>id</tt> and <tt>value</tt> are external variables, and <tt>executeSql</tt> maps the items in the array to the <tt>?</tt>s.</p>
<p>To select values from the table, use a callback to capture the results:</p>
<pre class="cpp">tx<span class="operator">.</span>executeSql(<span class="char">'SELECT * FROM foo'</span><span class="operator">,</span> <span class="operator">[</span><span class="operator">]</span><span class="operator">,</span> function(tx<span class="operator">,</span> results) {
    <span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span> <span class="operator">,</span> len <span class="operator">=</span> results<span class="operator">.</span>rows<span class="operator">.</span>length; i <span class="operator">&lt;</span> len; i<span class="operator">+</span><span class="operator">+</span>) {
        <span class="comment">// do something with results.rows.item(i).text</span>
    }
});</pre>
<p>No fields are mapped in the above query, but to use the third argument you need to pass in an empty array as the second argument.</p>
<p>The SQL statement callback for <tt>executeSQL()</tt> is called with the <tt>transaction</tt> object and a SQL statement <tt>result</tt> object. The <tt>result</tt> gives access to the ID of the last inserted row, the number of rows affected, and an indexed list representing the rows returned, in the order returned.</p>
<p>The <tt>result</tt> object contains an array-like <tt>rows</tt> object. It has a length, but to access individual rows you need to use <tt>results.rows.item(i)</tt>, where <tt>i</tt> is the index of the row. This returns an object representation of each row. For example, if your database has a <tt>name</tt> and an <tt>age</tt> field, the <tt>row</tt> contains a <tt>name</tt> and an <tt>age</tt> property. The value of the <tt>age</tt> field can be accessed using <tt>results.rows.item(i).age</tt>.</p>
<a name="ooo-changing-database-versions"></a>
<h4>ooo Changing Database Versions</h4>
<p>Each database has one version at a time and multiple versions cannot exist at one time. Versions allow you to manage schema changes incrementally.</p>
<p>You can change the version of a client-side Web SQL database using the <tt>changeversion()</tt> method:</p>
<pre class="cpp"><span class="keyword">if</span> (db<span class="operator">.</span>version <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>) {
    <span class="keyword">try</span> {
        <span class="comment">// comment out for crash recovery.</span>
        db<span class="operator">.</span>changeVersion(<span class="string">&quot;1.0&quot;</span><span class="operator">,</span> <span class="string">&quot;2.0&quot;</span><span class="operator">,</span> cv_1_0_2_0<span class="operator">,</span> oops_1_0_2_0<span class="operator">,</span> success_1_0_2_0);
    } <span class="keyword">catch</span>(e) {
        alert(<span class="char">'changeversion 1.0 -&gt; 2.0 failed'</span>);
        alert(<span class="char">'DB Version: '</span><span class="operator">+</span>db<span class="operator">.</span>version);
    }
}</pre>
<p><tt>changeversion()</tt> takes the following arguments: required old and new version numbers, optional SQL transaction callback, optional SQL transaction error callback, and optional success callback.</p>
<ul>
<li>Web SQL</li>
<li>(indexedDB)</li>
</ul>
<a name="xxx"></a>
<h2>XXX ???</h2>
<a name="ooo-web-storage"></a>
<h4>ooo Web Storage</h4>
<p>Browser 8.5 supports HTML5's <tt>localStorage</tt> and <tt>sessionStorage</tt> APIs, which offer a site up to 5MB of combined data storage on the client browser. <i>Local</i> data is indefinitely persistent and available to all pages per domain, while <i>session</i> data is confined for the duration of a single window.</p>
<p>Databases are available via <tt>window.localStorage</tt> and <tt>window.sessionStorage</tt> objects. You access these databases the same way, via key/value pairs where both are represented as strings. The <tt>setItem()</tt>, <tt>getItem()</tt>, and <tt>removeItem()</tt> methods affect individual database keys, while <tt>clear()</tt> removes all data. The <tt>length()</tt> and <tt>key()</tt> methods allow you to traverse databases using array indexes:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var key<span class="operator">,</span> value;
<span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span><span class="operator">,</span> l <span class="operator">=</span> db<span class="operator">.</span>length ; i <span class="operator">&lt;</span> l ; i<span class="operator">+</span><span class="operator">+</span>) {
    key <span class="operator">=</span> db<span class="operator">.</span>key(i);
    value <span class="operator">=</span> db<span class="operator">.</span>getItem(key);
}</pre>
<p>Changes to a database can be examined via <tt>storage</tt> events that fire on the <tt>window</tt> object. Call <tt>event.oldValue</tt> and <tt>event.newValue</tt> to access the data. Call <tt>key</tt> for the name of the modified field, <tt>url</tt> for the page modifying the field, or <tt>storageArea</tt> for either database that is being modified.</p>
<a name="ooo-simple-data-storage"></a>
<h4>ooo Simple Data Storage</h4>
<p>The <tt>localStorage</tt> and <tt>sessionStorage</tt> APIs offer applications up to 5MB of data storage. They both share the same simple key/value interface, but have different namespaces and also differ in the extent to which data is available. Local storage persists indefinitely, while session storage only lasts for the duration of a window session. Local storage is available from any page or window from the same site, while session storage is local to each window.</p>
<p>The following set of examples demonstrate the API interface. While these use <tt>localStorage</tt> as an example, the same set of API calls work for <tt>sessionStorage</tt>, which is also available within the <tt>window</tt> object.</p>
<p>The following performs an initial check for support of browser-based storage and makes the database available within a variable:</p>
<pre class="cpp"><span class="keyword">if</span> (window<span class="operator">.</span>localStorage) {
    var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
    <span class="comment">// storage functionality here</span>
}
<span class="keyword">else</span> {
    <span class="comment">// store data remotely?</span>
}</pre>
<p>The <tt>getItem()</tt> method retrieves the value of a database field named <b>key</b>:</p>
<pre class="cpp">var value <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;key&quot;</span>);</pre>
<p>Both keys and values are represented as strings. If you specify any other type of data, it is converted silently to a string. (See <sub>Storing Non-String Data</sub> for ways around this limitation.) If <tt>getItem()</tt> returns <tt>null</tt> rather than a string value, it means the specified key does not exist.</p>
<p>The <tt>setItem()</tt> method establishes a new value. When adding data, it is a good idea to check to make sure you haven't exceeded the allotted storage space:</p>
<pre class="cpp"><span class="keyword">try</span> {
    db<span class="operator">.</span>setItem(<span class="string">&quot;key&quot;</span><span class="operator">,</span> <span class="string">&quot;string&quot;</span>);
}
<span class="keyword">catch</span>(err) {
    <span class="keyword">if</span> (err<span class="operator">.</span>QUOTA_EXCEEDED_ERR) {
        <span class="comment">// not enough storage space</span>
    }
}</pre>
<p>The <tt>removeItem()</tt> method deletes database fields:</p>
<pre class="cpp">db<span class="operator">.</span>removeItem(<span class="string">&quot;key&quot;</span>);</pre>
<p>The <tt>clear()</tt> method deletes all key/value pairs within the database, either for an entire site in the case of <tt>localStorage</tt>, or for an individual window session in the case of <tt>sessionStorage</tt>:</p>
<pre class="cpp">db<span class="operator">.</span>clear();</pre>
<p>Databases can be accessed as arrays using index notation, useful in cases where you may not know all the field names. The <tt>length</tt> property returns the number of fields in the database, and the <tt>key()</tt> method returns the name of the key corresponding to a given index. The following reflects the contents of a database in a JavaScript object:</p>
<pre class="cpp">var obj <span class="operator">=</span> {};
<span class="keyword">for</span> ( var i <span class="operator">=</span> <span class="number">0</span><span class="operator">,</span> l <span class="operator">=</span> db<span class="operator">.</span>length ; i <span class="operator">&lt;</span> l ; i<span class="operator">+</span><span class="operator">+</span> ) {
    obj<span class="operator">[</span> db<span class="operator">.</span>key(i) <span class="operator">]</span> <span class="operator">=</span> db<span class="operator">.</span>getItem( db<span class="operator">.</span>key(i) );
}</pre>
<p>Since keys correspond to array indexes, you should not add or remove keys during any operation that iterates over the full set of key/value pairs. Newly introduced keys are introduced randomly into the array's sequence.</p>
<p>The following displays simple storage functionality. The application prompts for a login and password if they are unavailable. This locally stored data is available the next time users open the browser, by pressing the icon in the top right of the main window. However, the contents of the credit card field is stored only for the duration of each browsing session.</p>
<p><a href="../examples/storage_data.htm"><img src="images/scr_storage_data.png" alt="" /> </a></p>
<p><a href="../examples/css/storage_data.css"><img src="images/icon_css.png" alt="" /> </a> <a href="../examples/js/storage_data.js"><img src="images/icon_js.png" alt="" /> </a></p>
<a name="ooo-storage-events"></a>
<h4>ooo Storage Events</h4>
<p>The <tt>storage</tt> event allows applications to respond indirectly to modified data resulting from calls to <tt>setItem()</tt>, <tt>removeItem()</tt>, or <tt>clear()</tt>. This may be useful in providing users with visual feedback notifying them of data that is modified locally, perhaps rather than being sent to a remote server:</p>
<pre class="cpp">window<span class="operator">.</span>addEventListener(<span class="string">&quot;storage&quot;</span><span class="operator">,</span> function(event){
    var icon <span class="operator">=</span> document<span class="operator">.</span>querySelector(<span class="string">&quot;#indicator&quot;</span>);
    <span class="keyword">if</span> (event<span class="operator">.</span>storageArea<span class="operator">.</span>length) {
        icon<span class="operator">.</span>className <span class="operator">=</span> <span class="string">&quot;writing&quot;</span>;
    }
    <span class="keyword">else</span> {
        icon<span class="operator">.</span>className <span class="operator">=</span> <span class="string">&quot;empty&quot;</span>;
    }
}<span class="operator">,</span> <span class="keyword">false</span>);</pre>
<p>The <tt>storage</tt> event's <tt>storageArea</tt> attribute returns the <tt>localStorage</tt> or <tt>sessionStorage</tt> object being modified. The <tt>key</tt> is the name of the field being modified, and <tt>oldValue</tt> and <tt>newValue</tt> are its values before and after the event. The <tt>url</tt> is the page that called the method triggering the change.</p>
<a name="ooo-storage-intro"></a>
<h4>ooo Storage Intro</h4>
<p>Traditional mobile web development centered around the limitations of client handsets, which had very little storage available for applications. As handsets have become more powerful, however, this is no longer the case. HTML5's newly introduced Storage, Application Cache and Offline features push more functionality out to the client browser and allow them to operate more autonomously as loosely coupled, independently synchronizing applications.</p>
<p>The Application Cache allows the browser to download applications so that they run entirely on the client browser. Navigating to a cache-enabled page silently installs its component files onto the browser. Users can then run the application locally on the client browser, independently of the site that supplied it.</p>
<p>Self-contained applications such as games and calculators run seamlessly in the absence of a network connection. Applications that rely on network connections can respond to changes in network availability with custom <b>offline</b> capabilities.</p>
<p>In addition to cached <i>applications</i>, standard <tt>LocalStorage</tt> and <tt>SessionStorage</tt> APIs are available to dynamically cache application <i>data</i>. These boost the amount of storage available to web applications and can effectively replace cookies as a means to track user preferences and maintain application state.</p>
<p>Both of these <i>web storage</i> mechanisms access data via simple key/value pairs. As an alternative, Web SQL brings SQLite-based structured database functionality, typically deployed on servers, to client browser applications. Web SQL is appropriate for data-intensive applications requiring complex queries rather than simple key/value access.</p>
<a name="ooo-storing-non-string-data"></a>
<h4>ooo Storing Non-String Data</h4>
<p>Since local and session storage APIs only support string values, you need to be careful not to allow errors that result from passive conversions from other data types. The following sample shows how such an error might occur:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var saveCardInfo;
    <span class="comment">// user expresses preference NOT to save credit card info:</span>
saveCardInfo <span class="operator">=</span> <span class="keyword">false</span>;
    <span class="comment">// BUG happens here...</span>
db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span><span class="operator">,</span> saveCardInfo);
    <span class="comment">// variable is now a string, not a boolean:</span>
saveCardInfo <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>);
    <span class="comment">// both &quot;true&quot; and &quot;false&quot; strings evaluate as true...</span>
<span class="keyword">if</span> ( saveCardInfo ) {
    <span class="comment">// ...so this code always executes...</span>
}
<span class="keyword">else</span> {
    <span class="comment">// ...and this code never executes.</span>
}</pre>
<p>The user's preference to retain credit card information is expressed within the application as a <tt>true</tt> or <tt>false</tt> boolean value. When each value is passed to storage, however, it is passively converted to a string. When reassigned to a JavaScript variable, it no longer serves as a valid boolean test. The application falsely assumes users want to save credit card information, regardless of their expressed preference.</p>
<p>The following example fixes the problem. Instead of using <tt>true</tt> and <tt>false</tt> boolean values, it converts <tt>1</tt> and <tt>0</tt> strings to numbers:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var saveCardInfo <span class="operator">=</span> <span class="number">0</span>;
db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span><span class="operator">,</span> saveCardInfo);
<span class="comment">// multiplying forces numeric output:</span>
saveCardInfo <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>) <span class="operator">*</span> <span class="number">1</span>;</pre>
<p>For a more reliable alternative, store values as JSON strings and rely on automatic type conversion when subsequently parsing them. The following sample shows how parsing JSON preserves both boolean and numeric data:</p>
<pre class="cpp">var saveCardInfo <span class="operator">=</span> <span class="keyword">true</span>;      <span class="comment">// boolean</span>
var shipMethod <span class="operator">=</span> <span class="number">2</span>;           <span class="comment">// number</span>
var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;

db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span> <span class="operator">,</span> JSON<span class="operator">.</span>stringify(saveCardInfo));
db<span class="operator">.</span>setItem(<span class="string">&quot;ship_method&quot;</span>    <span class="operator">,</span> JSON<span class="operator">.</span>stringify(shipMethod));

saveCardInfo <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>)); <span class="comment">// boolean</span>
shipMethod   <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;ship_method&quot;</span>));    <span class="comment">// number</span></pre>
<p>Note that this simple approach may cause problems of its own. For example, perhaps the words <b>true</b> and <b>false</b> really should be represented as strings. Encapsulating data within objects accounts for such variability:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var obj <span class="operator">=</span> {
    <span class="type">bool</span> : <span class="keyword">true</span><span class="operator">,</span>
    str  : <span class="string">&quot;true&quot;</span><span class="operator">,</span>
    num  : <span class="number">1</span>
};
db<span class="operator">.</span>setItem(<span class="string">&quot;appState&quot;</span><span class="operator">,</span> JSON<span class="operator">.</span>stringify(obj)); <span class="comment">// to database...</span>
<span class="comment">// &quot;appState&quot; is &quot;{'bool':true,'num':1,'str':'true'}&quot;</span>
obj <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;appState&quot;</span>));    <span class="comment">// ...and back</span>
<span class="comment">// obj is same as initially defined.</span></pre>
<p>The ability to save objects as JSON strings means that you can save an application's state within a single database field. For example, you might use the following approach to save the entire contents of a shopping cart in a single field for later use:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var cart <span class="operator">=</span> { items: <span class="operator">[</span><span class="operator">]</span> };

cart<span class="operator">.</span>message <span class="operator">=</span> <span class="string">&quot;From your loving uncle&quot;</span>;

cart<span class="operator">.</span>items<span class="operator">.</span>push({
    description : <span class="string">&quot;Floor to Ceiling Shoe Rack&quot;</span><span class="operator">,</span>
    id          : <span class="number">203174676</span><span class="operator">,</span>
    price       : <span class="number">99.95</span><span class="operator">,</span>
    quantity    : <span class="number">1</span><span class="operator">,</span>
    weight      : <span class="number">20</span><span class="operator">,</span>
});

cart<span class="operator">.</span>items<span class="operator">.</span>push({
    description : <span class="string">&quot;Automatic Laser Toy for Cats&quot;</span><span class="operator">,</span>
    id          : <span class="number">203345371</span><span class="operator">,</span>
    price       : <span class="number">19.95</span><span class="operator">,</span>
    quantity    : <span class="number">2</span><span class="operator">,</span>
    weight      : <span class="number">0.5</span><span class="operator">,</span>
});

<span class="comment">// save all cumulative items:</span>
db<span class="operator">.</span>setItem(<span class="string">&quot;cart&quot;</span><span class="operator">,</span> JSON<span class="operator">.</span>stringify(cart));

<span class="comment">// extract items from storage:</span>
cart <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;cart&quot;</span>));</pre>
<p>JSON allows you to store data types, but functions are ignored. That makes it more difficult to preserve objects representing fully functional applications.</p>
<ul>
<li>localStorage</li>
<li>sessionStorage</li>
</ul>
<a name="xxx"></a>
<h2>XXX ???</h2>
<a name="ooo-web-sql"></a>
<h4>ooo Web SQL</h4>
<p>Use the Web SQL feature for more advanced SQL-driven database applications that execute entirely on the client browser, but that fall beyond the capabilities of the simple key/value-based Web Storage system described above.</p>
<p>Use <tt>openDatabase</tt> to create or access a database, supplying parameters for unique database name, version number, display name, and estimated size:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'dbname'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my database'</span><span class="operator">,</span> <span class="number">1024</span>);</pre>
<p>You interact with the database using asynchronous SQL transactions. The following shows how you might create a table, insert data by mapping in JavaScript variables, and traverse existing data:</p>
<pre class="cpp">var x_id<span class="operator">,</span> x_value;
db<span class="operator">.</span>transaction(function (tx) {
    tx<span class="operator">.</span>executeSql(<span class="char">'CREATE TABLE IF NOT EXISTS tbl (id unique, text)'</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO tbl (id, text) VALUES (?, ?)'</span><span class="operator">,</span> <span class="operator">[</span>x_id<span class="operator">,</span> x_value<span class="operator">]</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'SELECT * FROM tbl'</span><span class="operator">,</span> <span class="operator">[</span><span class="operator">]</span><span class="operator">,</span> function(tx<span class="operator">,</span> results) {
        <span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span> <span class="operator">,</span> l <span class="operator">=</span> results<span class="operator">.</span>rows<span class="operator">.</span>length; i <span class="operator">&lt;</span> l; i<span class="operator">+</span><span class="operator">+</span>) {
            <span class="comment">// do something with results.rows.item(i).text</span>
        }
    });
});</pre>
<a name="ooo-web-sql-databases"></a>
<h4>ooo Web SQL Databases</h4>
<p>While common local- or session-based databases are capable of storing complex data structures, WebKit-based browsers can also rely upon the Web SQL standard, which brings SQLite-based structured database functionality, typically deployed on servers, to client browser applications. Based on SQLite version 3.6&#x2e;19, Web SQL is appropriate for data-intensive applications requiring complex queries rather than simple key/value access.</p>
<p>The following test confirms support for Web SQL:</p>
<pre class="cpp"><span class="keyword">if</span> (<span class="operator">!</span><span class="operator">!</span>window<span class="operator">.</span>openDatabase) {
    <span class="comment">// supports Web SQL</span>
}</pre>
<p>Calls to databases made via the Web SQL API are made asynchronously via transactions to avoid the user interface from locking up, as database interaction may occur from several windows at a time.</p>
<p>The three core API methods are:</p>
<ul>
<li><tt>openDatabase()</tt></li>
<li><tt>transaction()</tt></li>
<li><tt>executeSql()</tt></li>
</ul>
<a name="ooo-creating-and-opening-a-new-database"></a>
<h4>ooo Creating and Opening a New Database</h4>
<p>To create and open a database, use <tt>openDatabase()</tt>on the Window object, for example:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'mydb'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my first database'</span><span class="operator">,</span> <span class="number">2</span><span class="operator">*</span><span class="number">1024</span><span class="operator">*</span><span class="number">1024</span>);
var db <span class="operator">=</span> openDatabase(<span class="char">'notes'</span><span class="operator">,</span> <span class="char">''</span><span class="operator">,</span> <span class="char">'The Example Notes App!'</span><span class="operator">,</span> <span class="number">1048576</span>);</pre>
<p>The four required arguments are the database name, version, display name, and estimated size in bytes. You can supply a function as an optional fifth argument to serve as a callback when a database is created. It may be used to call the <tt>changeversion()</tt> method, in which case the callback is invoked with an empty string for the database version.</p>
<p>The second example above specifies an empty string for the version. In this case the database opens no matter what the database version is. (An <tt>openDatabase()</tt> call specifying the wrong version for an existing database throws an <tt>INVALID_STATE_ERR</tt> exception.) You can then query the version by examining the database object's version property, for example:</p>
<pre class="cpp">var version <span class="operator">=</span> db<span class="operator">.</span>version;</pre>
<p>Note that you don't need to close a client-side Web SQL database when you're done working with it.</p>
<a name="ooo-errors"></a>
<h4>ooo Errors</h4>
<p>Asynchronous API errors are reported using callbacks that have a <tt>SQLError</tt> object as one of their arguments. <tt>SQLError</tt> contains a code from the table below and a localized message string.</p>
<p>Error codes are:</p>
<ul>
<li>0 <tt>UNKNOWN_ERROR</tt> Transaction failed for reasons unrelated to the DB</li>
<li>1 <tt>DATABASE_ERROR</tt> Statement failed for DB reasons not covered by other code</li>
<li>2 <tt>VERSION_ERROR</tt> DB version doesn't match expected version</li>
<li>3 <tt>TOO_LARGE_ERROR</tt> Data returned from DB was too large. Try the <tt>SQL LIMIT</tt> modifier.</li>
<li>4 <tt>QUOTA_ERROR</tt> Insufficient remaining storage</li>
<li>5 <tt>SYNTAX_ERROR</tt> Syntax error, argument mismatch, or unallowed statement</li>
<li>6 <tt>CONSTRAINT_ERROR</tt> An <tt>INSERT</tt>, <tt>UPDATE</tt>, or <tt>REPLACE</tt> statement failed due to a constraint error</li>
<li>7 <tt>TIMEOUT_ERROR</tt> Timeout waiting for transaction lock</li>
</ul>
<p><b>See Also:</b> <a href="http://html5doctor.com/introducing-web-sql-databases/">HTML5 Doctor: Introducing Web SQL Databases</a></p>
<a name="ooo-transaction-calls-and-executesql-method"></a>
<h4>ooo Transaction Calls and ExecuteSQL Method</h4>
<p>Performing database transactions is superior to running SQL statements directly because transactions are not committed if they fail and you can undo them if needed. Transactions also allow you to handle errors using a callback. To implement a transaction, specify a callback function such as the following:</p>
<pre class="cpp">db<span class="operator">.</span>transaction(function (tx) {
  <span class="comment">// SQL details on the tx object go here</span>
}</pre>
<p>The <tt>transaction()</tt> method takes one to three arguments:</p>
<ul>
<li>a required transaction callback, in which <tt>executeSQL()</tt> calls belong</li>
<li>an optional transaction error object</li>
<li>an optional success callback.</li>
</ul>
<p>Use the <tt>executeSQL()</tt> method to specify SQL statements for read and write operations. The method protects against SQL injection and provides a callback method to process the results of any SQL queries you specify. The <tt>executeSQL()</tt> method takes from one to four arguments:</p>
<ul>
<li>a required SQL statement</li>
<li>an optional object array of arguments</li>
<li>an optional SQL statement callback</li>
<li>an optional SQL statement error callback</li>
</ul>
<p>The example below creates the database if it doesn't exist, adds a two-column table to the database, and adds a row of data to the table:</p>
<pre class="cpp">var db <span class="operator">=</span> openDatabase(<span class="char">'mydb'</span><span class="operator">,</span> <span class="char">'1.0'</span><span class="operator">,</span> <span class="char">'my first database'</span><span class="operator">,</span> <span class="number">2</span> <span class="operator">*</span> <span class="number">1024</span> <span class="operator">*</span> <span class="number">1024</span>);
db<span class="operator">.</span>transaction(function (tx) {
    tx<span class="operator">.</span>executeSql(<span class="char">'CREATE TABLE IF NOT EXISTS foo (id unique, text)'</span>);
    tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO foo (id, text) VALUES (1, &quot;synergies&quot;)'</span>);
});</pre>
<p>To capture data from the user or an external source, use <tt>?</tt> placeholders to map that data into the SQL query. This ensures the data doesn't compromise database security, for example from SQL injection:</p>
<pre class="cpp">tx<span class="operator">.</span>executeSql(<span class="char">'INSERT INTO foo (id, text) VALUES (?, ?)'</span><span class="operator">,</span> <span class="operator">[</span>id<span class="operator">,</span> value<span class="operator">]</span>);</pre>
<p><tt>id</tt> and <tt>value</tt> are external variables, and <tt>executeSql</tt> maps the items in the array to the <tt>?</tt>s.</p>
<p>To select values from the table, use a callback to capture the results:</p>
<pre class="cpp">tx<span class="operator">.</span>executeSql(<span class="char">'SELECT * FROM foo'</span><span class="operator">,</span> <span class="operator">[</span><span class="operator">]</span><span class="operator">,</span> function(tx<span class="operator">,</span> results) {
    <span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span> <span class="operator">,</span> len <span class="operator">=</span> results<span class="operator">.</span>rows<span class="operator">.</span>length; i <span class="operator">&lt;</span> len; i<span class="operator">+</span><span class="operator">+</span>) {
        <span class="comment">// do something with results.rows.item(i).text</span>
    }
});</pre>
<p>No fields are mapped in the above query, but to use the third argument you need to pass in an empty array as the second argument.</p>
<p>The SQL statement callback for <tt>executeSQL()</tt> is called with the <tt>transaction</tt> object and a SQL statement <tt>result</tt> object. The <tt>result</tt> gives access to the ID of the last inserted row, the number of rows affected, and an indexed list representing the rows returned, in the order returned.</p>
<p>The <tt>result</tt> object contains an array-like <tt>rows</tt> object. It has a length, but to access individual rows you need to use <tt>results.rows.item(i)</tt>, where <tt>i</tt> is the index of the row. This returns an object representation of each row. For example, if your database has a <tt>name</tt> and an <tt>age</tt> field, the <tt>row</tt> contains a <tt>name</tt> and an <tt>age</tt> property. The value of the <tt>age</tt> field can be accessed using <tt>results.rows.item(i).age</tt>.</p>
<a name="ooo-changing-database-versions"></a>
<h4>ooo Changing Database Versions</h4>
<p>Each database has one version at a time and multiple versions cannot exist at one time. Versions allow you to manage schema changes incrementally.</p>
<p>You can change the version of a client-side Web SQL database using the <tt>changeversion()</tt> method:</p>
<pre class="cpp"><span class="keyword">if</span> (db<span class="operator">.</span>version <span class="operator">=</span><span class="operator">=</span> <span class="string">&quot;1.0&quot;</span>) {
    <span class="keyword">try</span> {
        <span class="comment">// comment out for crash recovery.</span>
        db<span class="operator">.</span>changeVersion(<span class="string">&quot;1.0&quot;</span><span class="operator">,</span> <span class="string">&quot;2.0&quot;</span><span class="operator">,</span> cv_1_0_2_0<span class="operator">,</span> oops_1_0_2_0<span class="operator">,</span> success_1_0_2_0);
    } <span class="keyword">catch</span>(e) {
        alert(<span class="char">'changeversion 1.0 -&gt; 2.0 failed'</span>);
        alert(<span class="char">'DB Version: '</span><span class="operator">+</span>db<span class="operator">.</span>version);
    }
}</pre>
<p><tt>changeversion()</tt> takes the following arguments: required old and new version numbers, optional SQL transaction callback, optional SQL transaction error callback, and optional success callback.</p>
<ul>
<li>Web SQL</li>
<li>(indexedDB)</li>
</ul>
<a name="xxx"></a>
<h2>XXX ???</h2>
<a name="ooo-web-storage"></a>
<h4>ooo Web Storage</h4>
<p>Browser 8.5 supports HTML5's <tt>localStorage</tt> and <tt>sessionStorage</tt> APIs, which offer a site up to 5MB of combined data storage on the client browser. <i>Local</i> data is indefinitely persistent and available to all pages per domain, while <i>session</i> data is confined for the duration of a single window.</p>
<p>Databases are available via <tt>window.localStorage</tt> and <tt>window.sessionStorage</tt> objects. You access these databases the same way, via key/value pairs where both are represented as strings. The <tt>setItem()</tt>, <tt>getItem()</tt>, and <tt>removeItem()</tt> methods affect individual database keys, while <tt>clear()</tt> removes all data. The <tt>length()</tt> and <tt>key()</tt> methods allow you to traverse databases using array indexes:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var key<span class="operator">,</span> value;
<span class="keyword">for</span> (var i <span class="operator">=</span> <span class="number">0</span><span class="operator">,</span> l <span class="operator">=</span> db<span class="operator">.</span>length ; i <span class="operator">&lt;</span> l ; i<span class="operator">+</span><span class="operator">+</span>) {
    key <span class="operator">=</span> db<span class="operator">.</span>key(i);
    value <span class="operator">=</span> db<span class="operator">.</span>getItem(key);
}</pre>
<p>Changes to a database can be examined via <tt>storage</tt> events that fire on the <tt>window</tt> object. Call <tt>event.oldValue</tt> and <tt>event.newValue</tt> to access the data. Call <tt>key</tt> for the name of the modified field, <tt>url</tt> for the page modifying the field, or <tt>storageArea</tt> for either database that is being modified.</p>
<a name="ooo-simple-data-storage"></a>
<h4>ooo Simple Data Storage</h4>
<p>The <tt>localStorage</tt> and <tt>sessionStorage</tt> APIs offer applications up to 5MB of data storage. They both share the same simple key/value interface, but have different namespaces and also differ in the extent to which data is available. Local storage persists indefinitely, while session storage only lasts for the duration of a window session. Local storage is available from any page or window from the same site, while session storage is local to each window.</p>
<p>The following set of examples demonstrate the API interface. While these use <tt>localStorage</tt> as an example, the same set of API calls work for <tt>sessionStorage</tt>, which is also available within the <tt>window</tt> object.</p>
<p>The following performs an initial check for support of browser-based storage and makes the database available within a variable:</p>
<pre class="cpp"><span class="keyword">if</span> (window<span class="operator">.</span>localStorage) {
    var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
    <span class="comment">// storage functionality here</span>
}
<span class="keyword">else</span> {
    <span class="comment">// store data remotely?</span>
}</pre>
<p>The <tt>getItem()</tt> method retrieves the value of a database field named <b>key</b>:</p>
<pre class="cpp">var value <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;key&quot;</span>);</pre>
<p>Both keys and values are represented as strings. If you specify any other type of data, it is converted silently to a string. (See <sub>Storing Non-String Data</sub> for ways around this limitation.) If <tt>getItem()</tt> returns <tt>null</tt> rather than a string value, it means the specified key does not exist.</p>
<p>The <tt>setItem()</tt> method establishes a new value. When adding data, it is a good idea to check to make sure you haven't exceeded the allotted storage space:</p>
<pre class="cpp"><span class="keyword">try</span> {
    db<span class="operator">.</span>setItem(<span class="string">&quot;key&quot;</span><span class="operator">,</span> <span class="string">&quot;string&quot;</span>);
}
<span class="keyword">catch</span>(err) {
    <span class="keyword">if</span> (err<span class="operator">.</span>QUOTA_EXCEEDED_ERR) {
        <span class="comment">// not enough storage space</span>
    }
}</pre>
<p>The <tt>removeItem()</tt> method deletes database fields:</p>
<pre class="cpp">db<span class="operator">.</span>removeItem(<span class="string">&quot;key&quot;</span>);</pre>
<p>The <tt>clear()</tt> method deletes all key/value pairs within the database, either for an entire site in the case of <tt>localStorage</tt>, or for an individual window session in the case of <tt>sessionStorage</tt>:</p>
<pre class="cpp">db<span class="operator">.</span>clear();</pre>
<p>Databases can be accessed as arrays using index notation, useful in cases where you may not know all the field names. The <tt>length</tt> property returns the number of fields in the database, and the <tt>key()</tt> method returns the name of the key corresponding to a given index. The following reflects the contents of a database in a JavaScript object:</p>
<pre class="cpp">var obj <span class="operator">=</span> {};
<span class="keyword">for</span> ( var i <span class="operator">=</span> <span class="number">0</span><span class="operator">,</span> l <span class="operator">=</span> db<span class="operator">.</span>length ; i <span class="operator">&lt;</span> l ; i<span class="operator">+</span><span class="operator">+</span> ) {
    obj<span class="operator">[</span> db<span class="operator">.</span>key(i) <span class="operator">]</span> <span class="operator">=</span> db<span class="operator">.</span>getItem( db<span class="operator">.</span>key(i) );
}</pre>
<p>Since keys correspond to array indexes, you should not add or remove keys during any operation that iterates over the full set of key/value pairs. Newly introduced keys are introduced randomly into the array's sequence.</p>
<p>The following displays simple storage functionality. The application prompts for a login and password if they are unavailable. This locally stored data is available the next time users open the browser, by pressing the icon in the top right of the main window. However, the contents of the credit card field is stored only for the duration of each browsing session.</p>
<p><a href="../examples/storage_data.htm"><img src="images/scr_storage_data.png" alt="" /> </a></p>
<p><a href="../examples/css/storage_data.css"><img src="images/icon_css.png" alt="" /> </a> <a href="../examples/js/storage_data.js"><img src="images/icon_js.png" alt="" /> </a></p>
<a name="ooo-storage-events"></a>
<h4>ooo Storage Events</h4>
<p>The <tt>storage</tt> event allows applications to respond indirectly to modified data resulting from calls to <tt>setItem()</tt>, <tt>removeItem()</tt>, or <tt>clear()</tt>. This may be useful in providing users with visual feedback notifying them of data that is modified locally, perhaps rather than being sent to a remote server:</p>
<pre class="cpp">window<span class="operator">.</span>addEventListener(<span class="string">&quot;storage&quot;</span><span class="operator">,</span> function(event){
    var icon <span class="operator">=</span> document<span class="operator">.</span>querySelector(<span class="string">&quot;#indicator&quot;</span>);
    <span class="keyword">if</span> (event<span class="operator">.</span>storageArea<span class="operator">.</span>length) {
        icon<span class="operator">.</span>className <span class="operator">=</span> <span class="string">&quot;writing&quot;</span>;
    }
    <span class="keyword">else</span> {
        icon<span class="operator">.</span>className <span class="operator">=</span> <span class="string">&quot;empty&quot;</span>;
    }
}<span class="operator">,</span> <span class="keyword">false</span>);</pre>
<p>The <tt>storage</tt> event's <tt>storageArea</tt> attribute returns the <tt>localStorage</tt> or <tt>sessionStorage</tt> object being modified. The <tt>key</tt> is the name of the field being modified, and <tt>oldValue</tt> and <tt>newValue</tt> are its values before and after the event. The <tt>url</tt> is the page that called the method triggering the change.</p>
<a name="ooo-storage-intro"></a>
<h4>ooo Storage Intro</h4>
<p>Traditional mobile web development centered around the limitations of client handsets, which had very little storage available for applications. As handsets have become more powerful, however, this is no longer the case. HTML5's newly introduced Storage, Application Cache and Offline features push more functionality out to the client browser and allow them to operate more autonomously as loosely coupled, independently synchronizing applications.</p>
<p>The Application Cache allows the browser to download applications so that they run entirely on the client browser. Navigating to a cache-enabled page silently installs its component files onto the browser. Users can then run the application locally on the client browser, independently of the site that supplied it.</p>
<p>Self-contained applications such as games and calculators run seamlessly in the absence of a network connection. Applications that rely on network connections can respond to changes in network availability with custom <b>offline</b> capabilities.</p>
<p>In addition to cached <i>applications</i>, standard <tt>LocalStorage</tt> and <tt>SessionStorage</tt> APIs are available to dynamically cache application <i>data</i>. These boost the amount of storage available to web applications and can effectively replace cookies as a means to track user preferences and maintain application state.</p>
<p>Both of these <i>web storage</i> mechanisms access data via simple key/value pairs. As an alternative, Web SQL brings SQLite-based structured database functionality, typically deployed on servers, to client browser applications. Web SQL is appropriate for data-intensive applications requiring complex queries rather than simple key/value access.</p>
<a name="ooo-storing-non-string-data"></a>
<h4>ooo Storing Non-String Data</h4>
<p>Since local and session storage APIs only support string values, you need to be careful not to allow errors that result from passive conversions from other data types. The following sample shows how such an error might occur:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var saveCardInfo;
    <span class="comment">// user expresses preference NOT to save credit card info:</span>
saveCardInfo <span class="operator">=</span> <span class="keyword">false</span>;
    <span class="comment">// BUG happens here...</span>
db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span><span class="operator">,</span> saveCardInfo);
    <span class="comment">// variable is now a string, not a boolean:</span>
saveCardInfo <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>);
    <span class="comment">// both &quot;true&quot; and &quot;false&quot; strings evaluate as true...</span>
<span class="keyword">if</span> ( saveCardInfo ) {
    <span class="comment">// ...so this code always executes...</span>
}
<span class="keyword">else</span> {
    <span class="comment">// ...and this code never executes.</span>
}</pre>
<p>The user's preference to retain credit card information is expressed within the application as a <tt>true</tt> or <tt>false</tt> boolean value. When each value is passed to storage, however, it is passively converted to a string. When reassigned to a JavaScript variable, it no longer serves as a valid boolean test. The application falsely assumes users want to save credit card information, regardless of their expressed preference.</p>
<p>The following example fixes the problem. Instead of using <tt>true</tt> and <tt>false</tt> boolean values, it converts <tt>1</tt> and <tt>0</tt> strings to numbers:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var saveCardInfo <span class="operator">=</span> <span class="number">0</span>;
db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span><span class="operator">,</span> saveCardInfo);
<span class="comment">// multiplying forces numeric output:</span>
saveCardInfo <span class="operator">=</span> db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>) <span class="operator">*</span> <span class="number">1</span>;</pre>
<p>For a more reliable alternative, store values as JSON strings and rely on automatic type conversion when subsequently parsing them. The following sample shows how parsing JSON preserves both boolean and numeric data:</p>
<pre class="cpp">var saveCardInfo <span class="operator">=</span> <span class="keyword">true</span>;      <span class="comment">// boolean</span>
var shipMethod <span class="operator">=</span> <span class="number">2</span>;           <span class="comment">// number</span>
var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;

db<span class="operator">.</span>setItem(<span class="string">&quot;save_card_info&quot;</span> <span class="operator">,</span> JSON<span class="operator">.</span>stringify(saveCardInfo));
db<span class="operator">.</span>setItem(<span class="string">&quot;ship_method&quot;</span>    <span class="operator">,</span> JSON<span class="operator">.</span>stringify(shipMethod));

saveCardInfo <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;save_card_info&quot;</span>)); <span class="comment">// boolean</span>
shipMethod   <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;ship_method&quot;</span>));    <span class="comment">// number</span></pre>
<p>Note that this simple approach may cause problems of its own. For example, perhaps the words <b>true</b> and <b>false</b> really should be represented as strings. Encapsulating data within objects accounts for such variability:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var obj <span class="operator">=</span> {
    <span class="type">bool</span> : <span class="keyword">true</span><span class="operator">,</span>
    str  : <span class="string">&quot;true&quot;</span><span class="operator">,</span>
    num  : <span class="number">1</span>
};
db<span class="operator">.</span>setItem(<span class="string">&quot;appState&quot;</span><span class="operator">,</span> JSON<span class="operator">.</span>stringify(obj)); <span class="comment">// to database...</span>
<span class="comment">// &quot;appState&quot; is &quot;{'bool':true,'num':1,'str':'true'}&quot;</span>
obj <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;appState&quot;</span>));    <span class="comment">// ...and back</span>
<span class="comment">// obj is same as initially defined.</span></pre>
<p>The ability to save objects as JSON strings means that you can save an application's state within a single database field. For example, you might use the following approach to save the entire contents of a shopping cart in a single field for later use:</p>
<pre class="cpp">var db <span class="operator">=</span> window<span class="operator">.</span>localStorage;
var cart <span class="operator">=</span> { items: <span class="operator">[</span><span class="operator">]</span> };

cart<span class="operator">.</span>message <span class="operator">=</span> <span class="string">&quot;From your loving uncle&quot;</span>;

cart<span class="operator">.</span>items<span class="operator">.</span>push({
    description : <span class="string">&quot;Floor to Ceiling Shoe Rack&quot;</span><span class="operator">,</span>
    id          : <span class="number">203174676</span><span class="operator">,</span>
    price       : <span class="number">99.95</span><span class="operator">,</span>
    quantity    : <span class="number">1</span><span class="operator">,</span>
    weight      : <span class="number">20</span><span class="operator">,</span>
});

cart<span class="operator">.</span>items<span class="operator">.</span>push({
    description : <span class="string">&quot;Automatic Laser Toy for Cats&quot;</span><span class="operator">,</span>
    id          : <span class="number">203345371</span><span class="operator">,</span>
    price       : <span class="number">19.95</span><span class="operator">,</span>
    quantity    : <span class="number">2</span><span class="operator">,</span>
    weight      : <span class="number">0.5</span><span class="operator">,</span>
});

<span class="comment">// save all cumulative items:</span>
db<span class="operator">.</span>setItem(<span class="string">&quot;cart&quot;</span><span class="operator">,</span> JSON<span class="operator">.</span>stringify(cart));

<span class="comment">// extract items from storage:</span>
cart <span class="operator">=</span> JSON<span class="operator">.</span>parse(db<span class="operator">.</span>getItem(<span class="string">&quot;cart&quot;</span>));</pre>
<p>JSON allows you to store data types, but functions are ignored. That makes it more difficult to preserve objects representing fully functional applications.</p>
<ul>
<li>localStorage</li>
<li>sessionStorage</li>
</ul>
</div>
<!-- @@@storage.html -->
<!-- END -->
<?php include('../../footer.inc'); ?></body>
</html>
